<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì¶œí‡´ê·¼ì•±</title>
  </head>
  <body>
    <p>ë¡œë”©ì¤‘...</p>

    <script type="module">
      import { PushNotifications } from "@capacitor/push-notifications";

      let deeplinkOpened = false;

      /* -----------------------------------------------------
        ğŸ”— 1) ë”¥ë§í¬ ì²˜ë¦¬
      ----------------------------------------------------- */
      if (window.Capacitor) {
        const { App } = window.Capacitor.Plugins;

        App.addListener("appUrlOpen", (event) => {
          deeplinkOpened = true;
          console.log("ì•±ìœ¼ë¡œ ì—´ë¦¼:", event.url);

          if (event.url.includes("/main/in.html")) {
            window.location.href = "./main/in.html";
          } else if (event.url.includes("/main/out.html")) {
            window.location.href = "./main/out.html";
          } else if (event.url.includes("/main/table.html")) {
            window.location.href = "./main/table.html";
          } else if (event.url.includes("/main/home.html")) {
            window.location.href = "./main/home.html";
          }
        });
      }

      // ë”¥ë§í¬ê°€ ì•„ë‹Œ ì¼ë°˜ ì‹¤í–‰ì¼ ë•Œë§Œ í™ˆ ì´ë™
      setTimeout(() => {
        if (!deeplinkOpened) {
          window.location.href = "./main/home.html";
        }
      }, 200);

      /* -----------------------------------------------------
        ğŸ”¥ 2) FCM í‘¸ì‹œ ì•Œë¦¼ ì„¤ì •
      ----------------------------------------------------- */
      async function initFCM() {
        try {
          // ê¶Œí•œ ì²´í¬
          let perm = await PushNotifications.checkPermissions();

          if (perm.receive !== "granted") {
            perm = await PushNotifications.requestPermissions();
          }

          // í† í° ìš”ì²­
          PushNotifications.register();

          // í† í° ìˆ˜ì‹ 
          PushNotifications.addListener("registration", (token) => {
            console.log("ğŸ”‘ FCM Token:", token.value);

            // í•„ìš”í•˜ë©´ ì›¹ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            localStorage.setItem("fcmToken", token.value);
          });

          // ë“±ë¡ ì˜¤ë¥˜
          PushNotifications.addListener("registrationError", (error) => {
            console.error("âŒ FCM Registration Error:", error);
          });

          // ì•±ì´ ì—´ë ¤ ìˆì„ ë•Œ ì•Œë¦¼ ìˆ˜ì‹ 
          PushNotifications.addListener(
            "pushNotificationReceived",
            (notification) => {
              console.log("ğŸ“© ì•Œë¦¼ ìˆ˜ì‹ :", notification);
              alert("í‘¸ì‹œ ì•Œë¦¼ ë„ì°©: " + notification.title);
            }
          );
        } catch (e) {
          console.error("FCM ì´ˆê¸°í™” ì˜¤ë¥˜:", e);
        }
      }

      // Capacitor í™˜ê²½ì¼ ë•Œë§Œ ì‹¤í–‰
      if (window.Capacitor) {
        initFCM();
      }
    </script>
  </body>
</html>
