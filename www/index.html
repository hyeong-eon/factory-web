<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì¶œí‡´ê·¼ì•±</title>
  </head>
  <body>
    <p>ë¡œë”©ì¤‘...</p>

    <script type="module">
      let deeplinkOpened = false;

      // ========== 1) ë”¥ë§í¬ ==========
      if (window.Capacitor) {
        const { App } = window.Capacitor.Plugins;

        App.addListener("appUrlOpen", (event) => {
          deeplinkOpened = true;
          console.log("ë”¥ë§í¬ í˜¸ì¶œë¨:", event.url);

          try {
            const url = new URL(event.url);
            const path = url.pathname; // "/main/in.html"

            if (path.endsWith("in.html")) {
              window.location.href = "/main/in.html";
            } else if (path.endsWith("out.html")) {
              window.location.href = "/main/out.html";
            } else if (path.endsWith("table.html")) {
              window.location.href = "/main/table.html";
            } else if (path.endsWith("home.html")) {
              window.location.href = "/main/home.html";
            }
          } catch (e) {
            console.error("ë”¥ë§í¬ íŒŒì‹± ì˜¤ë¥˜:", e);
          }
        });
      }

      // ========== 2) FCM ==========
      async function initFCM() {
        try {
          const PushNotifications = window.Capacitor.Plugins.PushNotifications;
          const { LocalNotifications } = window.Capacitor.Plugins;

          console.log("PushNotifications Plugin:", PushNotifications);

          let perm = await PushNotifications.checkPermissions();
          console.log("ğŸ“± í˜„ì¬ ê¶Œí•œ:", perm);

          if (perm.receive !== "granted") {
            perm = await PushNotifications.requestPermissions();
            console.log("ğŸ“± ê¶Œí•œ ìš”ì²­ ê²°ê³¼:", perm);
          }

          PushNotifications.register();

          PushNotifications.addListener("registration", (token) => {
            console.log("ğŸ”‘ FCM Token:", token.value);
            localStorage.setItem("fcmToken", token.value);
          });

          PushNotifications.addListener("registrationError", (err) => {
            console.error("âŒ registrationError:", err);
          });

          // í¬ê·¸ë¼ìš´ë“œì—ì„œ ì•Œë¦¼ ìˆ˜ì‹ 
          PushNotifications.addListener(
            "pushNotificationReceived",
            async (notification) => {
              console.log("ğŸ“© ì•Œë¦¼ ìˆ˜ì‹ :", notification);

              try {
                await LocalNotifications.schedule({
                  notifications: [
                    {
                      title: notification.title || "ì•Œë¦¼",
                      body: notification.body || "",
                      id: Date.now(),
                      schedule: { at: new Date(Date.now() + 100) },
                    },
                  ],
                });
                console.log("âœ… ë¡œì»¬ ì•Œë¦¼ í‘œì‹œ ì™„ë£Œ");
              } catch (e) {
                console.error("âŒ ë¡œì»¬ ì•Œë¦¼ ì—ëŸ¬:", e);
              }
            }
          );

          // ì•Œë¦¼ í´ë¦­ ì‹œ
          PushNotifications.addListener(
            "pushNotificationActionPerformed",
            (action) => {
              console.log("ğŸ‘† ì•Œë¦¼ í´ë¦­:", action);
            }
          );
        } catch (e) {
          console.error("FCM error:", e);
        }
      }

      // ========== 3) ì‹¤í–‰ ==========
      if (window.Capacitor) {
        initFCM();

        // ë”¥ë§í¬ ì—†ìœ¼ë©´ 1ì´ˆ í›„ í™ˆìœ¼ë¡œ
        setTimeout(() => {
          if (!deeplinkOpened) {
            window.location.href = "/main/home.html";
          }
        }, 1000);
      } else {
        // ì›¹ì—ì„œëŠ” ë°”ë¡œ í™ˆìœ¼ë¡œ
        window.location.href = "/main/home.html";
      }
    </script>
  </body>
</html>
