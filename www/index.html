<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì¶œí‡´ê·¼ì•±</title>
  </head>
  <body>
    <p>ë¡œë”©ì¤‘...</p>

    <script type="module">
      let deeplinkOpened = false;

      // ========== 1) ë”¥ë§í¬ ==========
      if (window.Capacitor) {
        const { App } = window.Capacitor.Plugins;

        App.addListener("appUrlOpen", (event) => {
          deeplinkOpened = true;
          console.log("ì•±ìœ¼ë¡œ ì—´ë¦¼:", event.url);

          if (event.url.includes("/main/in.html")) {
            window.location.href = "./main/in.html";
          } else if (event.url.includes("/main/out.html")) {
            window.location.href = "./main/out.html";
          } else if (event.url.includes("/main/table.html")) {
            window.location.href = "./main/table.html";
          } else if (event.url.includes("/main/home.html")) {
            window.location.href = "./main/home.html";
          }
        });
      }

      // ========== 2) FCM ==========
      async function initFCM() {
        try {
          const PushNotifications = window.Capacitor.Plugins.PushNotifications;

          console.log("PushNotifications Plugin:", PushNotifications);

          let perm = await PushNotifications.checkPermissions();
          if (perm.receive !== "granted") {
            perm = await PushNotifications.requestPermissions();
          }

          PushNotifications.register();

          PushNotifications.addListener("registration", (token) => {
            console.log("ğŸ”‘ FCM Token:", token.value);

            // í† í° ì €ì¥
            localStorage.setItem("fcmToken", token.value);

            // FCM ë“±ë¡ ëë‚¬ìœ¼ë©´ homeìœ¼ë¡œ ì´ë™
            if (!deeplinkOpened) {
              window.location.href = "./main/home.html";
            }
          });

          PushNotifications.addListener("registrationError", (err) => {
            console.error("âŒ registrationError:", err);
          });

          PushNotifications.addListener("pushNotificationReceived", (n) => {
            console.log("ğŸ“© ì•Œë¦¼ ìˆ˜ì‹ :", n);
          });
        } catch (e) {
          console.error("FCM error:", e);
        }
      }

      // ========== 3) ì‹¤í–‰ ==========
      if (window.Capacitor) {
        initFCM();
      } else {
        // ì›¹ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ê·¸ëƒ¥ í™ˆìœ¼ë¡œ ì´ë™
        window.location.href = "./main/home.html";
      }
    </script>
  </body>
</html>
